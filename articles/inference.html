<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Inference (Experimental) • xplainfi</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Inference (Experimental)">
<script defer src="https://umami.jemu.name/script.js" data-website-id="248c8668-4908-4c63-86f7-db0a1b19758a"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">xplainfi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9002</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/xplainfi.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Method Showcase</h6></li>
    <li><a class="dropdown-item" href="../articles/perturbation-importance.html">Perturbation-Based Methods (PFI, CFI, RFI)</a></li>
    <li><a class="dropdown-item" href="../articles/loco-loci.html">Leave-Out/In Methods (LOCO, LOCI)</a></li>
    <li><a class="dropdown-item" href="../articles/sage-methods.html">Shapley Additive Global Importance (SAGE)</a></li>
    <li><a class="dropdown-item" href="../articles/inference.html">Inference for Feature Importances</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Testing &amp; Validation</h6></li>
    <li><a class="dropdown-item" href="../articles/simulation-settings.html">Simulation Settings</a></li>
    <li><a class="dropdown-item" href="../articles/fippy-comparison.html">Comparison with fippy (Python)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jemus42/xplainfi/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<link href="inference_files/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet">
<script src="inference_files/htmlwidgets-1.6.4/htmlwidgets.js"></script><script src="inference_files/viz-1.8.2/viz.js"></script><link href="inference_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="inference_files/grViz-binding-1.0.11/grViz.js"></script><div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Inference (Experimental)</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jemus42/xplainfi/blob/main/vignettes/articles/inference.Rmd" class="external-link"><code>vignettes/articles/inference.Rmd</code></a></small>
      <div class="d-none name"><code>inference.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jemus42.github.io/xplainfi/">xplainfi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com" class="external-link">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: mlr3</span></span>
<span></span>
<span><span class="co"># Data manip and visualization</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<p>There are multiple (work in progress) inference possible with the
underlying implementation, but the API around them is still being worked
out.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>We use a simple linear DGP for demonstration purposes where</p>
<ul>
<li>
<span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_2\)</span> are strongly correlated</li>
<li>
<span class="math inline">\(X_1\)</span> and <span class="math inline">\(X_3\)</span> has an effect on Y</li>
<li>
<span class="math inline">\(X_2\)</span> and <span class="math inline">\(X_4\)</span> don’t have an effect</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_correlated</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">2000</span>, r <span class="op">=</span> <span class="fl">0.7</span><span class="op">)</span></span>
<span><span class="va">learner</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span>, num.trees <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">measure</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<div class="grViz html-widget html-fill-item" id="htmlwidget-ac96cb3ee4656e2e9ec3" style="width:960px;height:384px;"></div>
<script type="application/json" data-for="htmlwidget-ac96cb3ee4656e2e9ec3">{"x":{"diagram":"\n  digraph Correlated {\n    rankdir=LR;\n    graph [ranksep=1.5];\n    node [shape=circle, style=filled, fontsize=14, width=1.2];\n    \n    X1 [fillcolor=\"lightcoral\", label=\"X₁\n(β=2.0)\"];\n    X2 [fillcolor=\"pink\", label=\"X₂\n(β=0)\"];\n    X3 [fillcolor=\"lightblue\", label=\"X₃\n(β=1.0)\"];\n    X4 [fillcolor=\"lightgray\", label=\"X₄\n(β=0)\"];\n    Y [fillcolor=\"greenyellow\", label=\"Y\", width=1.5];\n    \n    X1 -> X2 [color=red, style=bold, dir=both, label=\"r = 0.7\"];\n    X1 -> Y [label=\"2.0\"];\n    X2 -> Y [style=dashed, color=gray, label=\"0\"];\n    X3 -> Y [label=\"1.0\"];\n    X4 -> Y [style=dashed, color=gray];\n    \n    {rank=source; X1; X3; X4}\n    {rank=same; X2}\n    {rank=sink; Y}\n  }","config":{"engine":"dot","options":null}},"evals":[],"jsHooks":[]}</script><p class="caption">
DAG for correlated features DGP
</p>
</div>
</div>
<div class="section level2">
<h2 id="variance-correction">Variance-correction<a class="anchor" aria-label="anchor" href="#variance-correction"></a>
</h2>
<p>When we calculate PFI using an appropriate resampling, such as
subsampling with 15 repeats, we can use the approach recommended by
Molnar et al. (2023) based on the proposed correction by Nadeay &amp;
Bengio (2003).</p>
<p>By default, any importance measures’ <code>$importance()</code>
method will not output any variances or confidence intervals, it will
merely compute averages over resampling iterations and repeats within
resamplings (<code>iter_perm</code> here).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi</span> <span class="op">=</span> <span class="va"><a href="../reference/PFI.html">PFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"subsampling"</span>, repeats <span class="op">=</span> <span class="fl">15</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    iters_perm <span class="op">=</span> <span class="fl">10</span> <span class="co"># for stability within resampling iters</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">pfi</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  6.444709393</span></span>
<span><span class="co">#&gt; 2:      x2  0.097777103</span></span>
<span><span class="co">#&gt; 3:      x3  1.801488945</span></span>
<span><span class="co">#&gt; 4:      x4 -0.001099328</span></span></code></pre></div>
<p>If we want unadjusted confidence intervals we can ask for them, but
note these are too narrow / optimistic and hence invalid for
inference:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_ci_raw</span> <span class="op">=</span> <span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>variance_method <span class="op">=</span> <span class="st">"raw"</span><span class="op">)</span></span>
<span><span class="va">pfi_ci_raw</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance           se   conf_lower   conf_upper</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  6.444709393 0.0710846455  6.292247992  6.597170794</span></span>
<span><span class="co">#&gt; 2:      x2  0.097777103 0.0040374343  0.089117668  0.106436538</span></span>
<span><span class="co">#&gt; 3:      x3  1.801488945 0.0163236399  1.766478220  1.836499671</span></span>
<span><span class="co">#&gt; 4:      x4 -0.001099328 0.0003169572 -0.001779133 -0.000419522</span></span></code></pre></div>
<p>Analogously we can retrieve the Nadeau &amp; Bengio-adjusted standard
errors and derived confidence intervals which were demonstrated to have
better (but still imperfect) coverage:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_ci_corrected</span> <span class="op">=</span> <span class="va">pfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>variance_method <span class="op">=</span> <span class="st">"nadeau_bengio"</span><span class="op">)</span></span>
<span><span class="va">pfi_ci_corrected</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance           se  conf_lower   conf_upper</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;        &lt;num&gt;       &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  6.444709393 0.2073141539  6.00006476 6.8893540305</span></span>
<span><span class="co">#&gt; 2:      x2  0.097777103 0.0117749378  0.07252237 0.1230318328</span></span>
<span><span class="co">#&gt; 3:      x3  1.801488945 0.0476069279  1.69938224 1.9035956504</span></span>
<span><span class="co">#&gt; 4:      x4 -0.001099328 0.0009243869 -0.00308194 0.0008832851</span></span></code></pre></div>
<p>To highlight just how large the difference between the two can be, we
quickly visualize them:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pfi_cis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="va">pfi_ci_raw</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="st">"raw"</span><span class="op">]</span>,</span>
<span>    <span class="va">pfi_ci_corrected</span><span class="op">[</span>, <span class="va">type</span> <span class="op">:=</span> <span class="st">"corrected"</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pfi_cis</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">feature</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">conf_lower</span>, xmax <span class="op">=</span> <span class="va">conf_upper</span><span class="op">)</span>, position <span class="op">=</span> <span class="st">"dodge"</span>, width <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">importance</span><span class="op">)</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inference_files/figure-html/pfi-ci-comparison-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="conditional-predictive-impact-cpi">Conditional predictive impact (CPI)<a class="anchor" aria-label="anchor" href="#conditional-predictive-impact-cpi"></a>
</h2>
<p>CPI is implemented by <a href="https://bips-hb.github.io/cpi/articles/intro.html" class="external-link">the cpi
package</a>, and provides conditional variable importance using
knockoffs. It works with <code>mlr3</code> and its output on our data
looks like this:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bips-hb/cpi" class="external-link">cpi</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">resampling</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">resampling</span><span class="op">$</span><span class="fu">instantiate</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cpi_res</span> <span class="op">=</span> <span class="fu"><a href="https://bips-hb.github.io/cpi/reference/cpi.html" class="external-link">cpi</a></span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    test <span class="op">=</span> <span class="st">"t"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">cpi_res</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">cpi_res</span>, <span class="st">"Variable"</span>, <span class="st">"feature"</span><span class="op">)</span></span>
<span><span class="va">cpi_res</span><span class="op">[</span>, <span class="va">method</span> <span class="op">:=</span> <span class="st">"CPI"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">cpi_res</span></span>
<span><span class="co">#&gt;    feature           CPI           SE   test statistic      estimate</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;        &lt;num&gt; &lt;char&gt;     &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  4.4905247594 0.1393416714      t 32.226718  4.4905247594</span></span>
<span><span class="co">#&gt; 2:      x2 -0.0026748965 0.0023132871      t -1.156318 -0.0026748965</span></span>
<span><span class="co">#&gt; 3:      x3  1.7350915247 0.0551007024      t 31.489463  1.7350915247</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0009994758 0.0009142715      t -1.093194 -0.0009994758</span></span>
<span><span class="co">#&gt;          p.value        ci.lo method</span></span>
<span><span class="co">#&gt;            &lt;num&gt;        &lt;num&gt; &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1: 3.644769e-184  4.261221841    CPI</span></span>
<span><span class="co">#&gt; 2:  8.761554e-01 -0.006481679    CPI</span></span>
<span><span class="co">#&gt; 3: 2.156035e-177  1.644416914    CPI</span></span>
<span><span class="co">#&gt; 4:  8.627797e-01 -0.002504016    CPI</span></span></code></pre></div>
<div class="section level3">
<h3 id="cpi-with-knockoffs">CPI with knockoffs<a class="anchor" aria-label="anchor" href="#cpi-with-knockoffs"></a>
</h3>
<p>Since <code>xplainfi</code> also includes knockoffs via the
<code>KnockoffSampler</code> and the
<code>KnockoffGaussianSampler</code>, the latter implemented the second
order Gaussian knockoffs also used per default in <a href="https://github.com/bips-hb/cpi" class="external-link">cpi</a>, we
can recreate its results using <code>CFI</code> with the corresponding
<code>sampler</code>. The important result however is not the
<code>$importance()</code>, but the observation-wise losses which are
the base for the CPI test.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knockoff_gaussian</span> <span class="op">=</span> <span class="va"><a href="../reference/KnockoffGaussianSampler.html">KnockoffGaussianSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi</span> <span class="op">=</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">knockoff_gaussian</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># showing importance here for illustration</span></span>
<span><span class="va">cfi</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature    importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  4.6485211373</span></span>
<span><span class="co">#&gt; 2:      x2 -0.0002372201</span></span>
<span><span class="co">#&gt; 3:      x3  1.8639780917</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0002621368</span></span>
<span></span>
<span><span class="co"># Extract observation-wise losses</span></span>
<span><span class="va">cfi_obs_loss</span> <span class="op">=</span> <span class="va">cfi</span><span class="op">$</span><span class="fu">obs_loss</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cfi_obs_loss</span><span class="op">)</span></span>
<span><span class="co">#&gt;    feature iter_rsmp iter_perm row_ids loss_baseline loss_post obs_importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;int&gt;     &lt;int&gt;   &lt;int&gt;         &lt;num&gt;     &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1         1         1       6   0.033999520 4.9474560      4.9134565</span></span>
<span><span class="co">#&gt; 2:      x1         1         1       9   0.083286015 9.9966152      9.9133292</span></span>
<span><span class="co">#&gt; 3:      x1         1         1      12   0.194163837 0.6922831      0.4981192</span></span>
<span><span class="co">#&gt; 4:      x1         1         1      16   0.015719984 0.5146092      0.4988892</span></span>
<span><span class="co">#&gt; 5:      x1         1         1      18   0.032886056 7.4098215      7.3769355</span></span>
<span><span class="co">#&gt; 6:      x1         1         1      25   0.006547662 8.6526833      8.6461356</span></span></code></pre></div>
<p>With the observation-wise losses, we can conduct the one-sided t-test
also performed by <code><a href="https://bips-hb.github.io/cpi/reference/cpi.html" class="external-link">cpi()</a></code> by default:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfi_cpi_res</span> <span class="op">=</span> <span class="va">cfi_obs_loss</span><span class="op">[</span>,</span>
<span>    <span class="op">{</span></span>
<span>        <span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span></span>
<span>            <span class="va">obs_importance</span>,</span>
<span>            alternative <span class="op">=</span> <span class="st">"greater"</span>,</span>
<span>            conf.level <span class="op">=</span> <span class="fl">0.95</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu">.</span><span class="op">(</span></span>
<span>            CPI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span>,</span>
<span>            SE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            statistic <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">statistic</span>,</span>
<span>            estimate <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>            p.value <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>            ci.lo <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>            method <span class="op">=</span> <span class="st">"CFI+Knockoffs"</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    by <span class="op">=</span> <span class="va">feature</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">cfi_cpi_res</span></span>
<span><span class="co">#&gt;    feature           CPI           SE   statistic      estimate       p.value</span></span>
<span><span class="co">#&gt;     &lt;char&gt;         &lt;num&gt;        &lt;num&gt;       &lt;num&gt;         &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  4.6485211373 0.1412096720 32.91928289  4.6485211373 1.430822e-190</span></span>
<span><span class="co">#&gt; 2:      x2 -0.0002372201 0.0029839960 -0.07949746 -0.0002372201  5.316775e-01</span></span>
<span><span class="co">#&gt; 3:      x3  1.8639780917 0.0561726066 33.18304428  1.8639780917 5.072022e-193</span></span>
<span><span class="co">#&gt; 4:      x4 -0.0002621368 0.0007881572 -0.33259452 -0.0002621368  6.302624e-01</span></span>
<span><span class="co">#&gt;           ci.lo        method</span></span>
<span><span class="co">#&gt;           &lt;num&gt;        &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:  4.416144207 CFI+Knockoffs</span></span>
<span><span class="co">#&gt; 2: -0.005147732 CFI+Knockoffs</span></span>
<span><span class="co">#&gt; 3:  1.771539538 CFI+Knockoffs</span></span>
<span><span class="co">#&gt; 4: -0.001559141 CFI+Knockoffs</span></span></code></pre></div>
<p>The results should be very similar to those computed by
<code><a href="https://bips-hb.github.io/cpi/reference/cpi.html" class="external-link">cpi()</a></code>, so let’s compare them:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">cpi_res</span>, <span class="va">cfi_cpi_res</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">feature</span>, x <span class="op">=</span> <span class="va">CPI</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">CPI</span>, xmax <span class="op">=</span> <span class="va">ci.lo</span><span class="op">)</span>,</span>
<span>        position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">0.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"CPI and CFI with Knockoff sampler"</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"RF with 5-fold CV"</span>,</span>
<span>        color <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inference_files/figure-html/cpi-cfi-plot-1.png" width="768"></p>
<p>A noteable caveat of the knockoff approach is that they are not
readily available for mixed data (with categorical features).</p>
</div>
<div class="section level3">
<h3 id="cpi-with-arf">CPI with ARF<a class="anchor" aria-label="anchor" href="#cpi-with-arf"></a>
</h3>
<p>An alternative is available using ARF as conditional sampler rather
than knockoffs (CITE cARFi), which we can perform analogously:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">arf_sampler</span> <span class="op">=</span> <span class="va"><a href="../reference/ARFSampler.html">ARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    finite_bounds <span class="op">=</span> <span class="st">"local"</span>,</span>
<span>    min_node_size <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    epsilon <span class="op">=</span> <span class="fl">1e-15</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi_arf</span> <span class="op">=</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="va">resampling</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">arf_sampler</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cfi_arf</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># showing importance here for illustration</span></span>
<span><span class="va">cfi_arf</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature   importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  3.916755677</span></span>
<span><span class="co">#&gt; 2:      x2  0.001979266</span></span>
<span><span class="co">#&gt; 3:      x3  1.757978495</span></span>
<span><span class="co">#&gt; 4:      x4 -0.001232825</span></span>
<span></span>
<span><span class="co"># Extract observation-wise losses</span></span>
<span><span class="va">cfi_arf_obs_loss</span> <span class="op">=</span> <span class="va">cfi_arf</span><span class="op">$</span><span class="fu">obs_loss</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cfi_arf_obs_loss</span><span class="op">)</span></span>
<span><span class="co">#&gt;    feature iter_rsmp iter_perm row_ids loss_baseline  loss_post obs_importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;int&gt;     &lt;int&gt;   &lt;int&gt;         &lt;num&gt;      &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1         1         1       6   0.042701587 21.4183325     21.3756309</span></span>
<span><span class="co">#&gt; 2:      x1         1         1       9   0.095974835  0.7633119      0.6673370</span></span>
<span><span class="co">#&gt; 3:      x1         1         1      12   0.244698470  2.9890856      2.7443871</span></span>
<span><span class="co">#&gt; 4:      x1         1         1      16   0.016257283 10.9607339     10.9444766</span></span>
<span><span class="co">#&gt; 5:      x1         1         1      18   0.035470161  5.7731139      5.7376437</span></span>
<span><span class="co">#&gt; 6:      x1         1         1      25   0.009120495  0.3782982      0.3691777</span></span></code></pre></div>
<p>With the observation-wise losses, we can conduct the one-sided t-test
also performed by <code><a href="https://bips-hb.github.io/cpi/reference/cpi.html" class="external-link">cpi()</a></code> by default:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cfi_arf_res</span> <span class="op">=</span> <span class="va">cfi_arf_obs_loss</span><span class="op">[</span>,</span>
<span>    <span class="op">{</span></span>
<span>        <span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/t.test.html" class="external-link">t.test</a></span><span class="op">(</span></span>
<span>            <span class="va">obs_importance</span>,</span>
<span>            alternative <span class="op">=</span> <span class="st">"greater"</span>,</span>
<span>            conf.level <span class="op">=</span> <span class="fl">0.95</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu">.</span><span class="op">(</span></span>
<span>            CPI <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span>,</span>
<span>            SE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            statistic <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">statistic</span>,</span>
<span>            estimate <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>            p.value <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>            ci.lo <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>            method <span class="op">=</span> <span class="st">"CFI+ARF"</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    by <span class="op">=</span> <span class="va">feature</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">cfi_arf_res</span></span>
<span><span class="co">#&gt;    feature          CPI          SE  statistic     estimate       p.value</span></span>
<span><span class="co">#&gt;     &lt;char&gt;        &lt;num&gt;       &lt;num&gt;      &lt;num&gt;        &lt;num&gt;         &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1  3.916755677 0.132819130 29.4893941  3.916755677 2.670941e-159</span></span>
<span><span class="co">#&gt; 2:      x2  0.001979266 0.002531915  0.7817271  0.001979266  2.172338e-01</span></span>
<span><span class="co">#&gt; 3:      x3  1.757978495 0.056717538 30.9953246  1.757978495 6.968806e-173</span></span>
<span><span class="co">#&gt; 4:      x4 -0.001232825 0.000758003 -1.6264117 -0.001232825  9.479901e-01</span></span>
<span><span class="co">#&gt;           ci.lo  method</span></span>
<span><span class="co">#&gt;           &lt;num&gt;  &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:  3.698186358 CFI+ARF</span></span>
<span><span class="co">#&gt; 2: -0.002187294 CFI+ARF</span></span>
<span><span class="co">#&gt; 3:  1.664643193 CFI+ARF</span></span>
<span><span class="co">#&gt; 4: -0.002480207 CFI+ARF</span></span></code></pre></div>
<p>We can now compare all three methods:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">cpi_res</span>, <span class="va">cfi_cpi_res</span>, <span class="va">cfi_arf_res</span><span class="op">)</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">feature</span>, x <span class="op">=</span> <span class="va">CPI</span>, color <span class="op">=</span> <span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">CPI</span>, xmax <span class="op">=</span> <span class="va">ci.lo</span><span class="op">)</span>,</span>
<span>        position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>        width <span class="op">=</span> <span class="fl">0.5</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>        title <span class="op">=</span> <span class="st">"CPI and CFI with Knockoffs and ARF"</span>,</span>
<span>        subtitle <span class="op">=</span> <span class="st">"RF with 5-fold CV"</span>,</span>
<span>        color <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">14</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<p><img src="inference_files/figure-html/cpi-cfi-arf-plot-1.png" width="768"></p>
<p>As expected, the ARF-based approach differs more from both
knockoff-based approaches, but they are all roughly in agreement.</p>
<p><strong>Note</strong>: <code>xplainfi</code> will gain a dedicated
interface to perform CPI, but the API is yet to be worked out.</p>
</div>
</div>
<div class="section level2">
<h2 id="loco-wip">LOCO (WIP)<a class="anchor" aria-label="anchor" href="#loco-wip"></a>
</h2>
<p>(CITATION) proposed inference for LOCO using the median absolute
differences of the baseline- and post-refit loss differences</p>
<p><span class="math display">\[
\theta_j = \mathrm{med}\left(
    |Y - \hat{f}_{n_1}^{-j}(X)| - |Y - \hat{f}_{n_1}(X)| \big| D_1
\right)
\]</span></p>
<p>If we apply <code>LOCO</code> as implemented in <code>xplainfi</code>
using the median absolute error (MAE) as our measure including the
median as the aggregation function, we unfortunately get something else,
though:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">measure_mae</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mae"</span><span class="op">)</span></span>
<span><span class="va">measure_mae</span><span class="op">$</span><span class="va">aggregator</span> <span class="op">=</span> <span class="va">median</span></span>
<span></span>
<span><span class="va">loco</span> <span class="op">=</span> <span class="va"><a href="../reference/LOCO.html">LOCO</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task</span>,</span>
<span>    learner <span class="op">=</span> <span class="va">learner</span>,</span>
<span>    resampling <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">rsmp</a></span><span class="op">(</span><span class="st">"cv"</span>, folds <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="va">measure_mae</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">loco</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">loco</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Key: &lt;feature&gt;</span></span>
<span><span class="co">#&gt;    feature importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1 0.97525707</span></span>
<span><span class="co">#&gt; 2:      x2 0.03986156</span></span>
<span><span class="co">#&gt; 3:      x3 0.63630022</span></span>
<span><span class="co">#&gt; 4:      x4 0.04484123</span></span></code></pre></div>
<p>This is <strong>not</strong> exactly what the authors propose,
because <code>$score()</code> calculates the aggregation function
(<code>median</code>) for each resampling iteration first, and takes the
difference afterwards, i.e.</p>
<p><span class="math display">\[
\theta_j = \mathrm{med}\left(|Y - \hat{f}_{n_1}^{-j}(X)|\right) -
\mathrm{med}\left(|Y - \hat{f}_{n_1}(X)| \big| D_1
\right)
\]</span></p>
<p>In the default case where the arithemtic mean is used, it does not
matter whether we calculate the difference of the means or the mean of
the differences, but using the median it does.</p>
<p>We can, however, reconstruct it by using the observation-wise losses
(in this case, the absolute error):</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loco_obsloss</span> <span class="op">=</span> <span class="va">loco</span><span class="op">$</span><span class="fu">obs_loss</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">loco_obsloss</span><span class="op">)</span></span>
<span><span class="co">#&gt;    feature iter_rsmp iter_refit row_ids loss_baseline loss_post obs_importance</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;int&gt;      &lt;num&gt;   &lt;int&gt;         &lt;num&gt;     &lt;num&gt;          &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1         1          1      42    0.05864333 0.5071679      0.4485246</span></span>
<span><span class="co">#&gt; 2:      x1         1          1      46    0.23216703 0.4272341      0.1950671</span></span>
<span><span class="co">#&gt; 3:      x1         1          1     105    0.24396323 2.3282881      2.0843249</span></span>
<span><span class="co">#&gt; 4:      x1         1          1     111    0.34811975 0.9381356      0.5900159</span></span>
<span><span class="co">#&gt; 5:      x1         1          1     115    0.05274243 2.6444159      2.5916735</span></span>
<span><span class="co">#&gt; 6:      x1         1          1     125    0.54248766 1.7175352      1.1750476</span></span></code></pre></div>
<p><code>obs_importance</code> here refers to the difference
<code>loss_post - loss_baseline</code>, so</p>
<ul>
<li>
<code>loss_baseline</code> $ = |Y - _{n_1}(X)|$</li>
<li>
<code>loss_post</code> $ = |Y - _{n_1}^{-j}(X)|$</li>
<li><code>obs_importance = loss_post - loss_baseline</code></li>
</ul>
<p>Which means by taking the median for each feature <span class="math inline">\(j\)</span> within each resampling iteration, we
can construct <span class="math inline">\(\theta_j(D_1)\)</span> as
proposed, for each set <span class="math inline">\(D_k\)</span> where
<span class="math inline">\(k\)</span> is the resampling iteration:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loco_thetas</span> <span class="op">=</span> <span class="va">loco_obsloss</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">obs_importance</span><span class="op">)</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"feature"</span>, <span class="st">"iter_rsmp"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">loco_thetas</span></span>
<span><span class="co">#&gt;     feature iter_rsmp      theta</span></span>
<span><span class="co">#&gt;      &lt;char&gt;     &lt;int&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1:      x1         1 0.85466423</span></span>
<span><span class="co">#&gt;  2:      x1         2 0.73690083</span></span>
<span><span class="co">#&gt;  3:      x1         3 0.94372755</span></span>
<span><span class="co">#&gt;  4:      x1         4 0.77573661</span></span>
<span><span class="co">#&gt;  5:      x1         5 0.81892731</span></span>
<span><span class="co">#&gt;  6:      x1         6 0.73694737</span></span>
<span><span class="co">#&gt;  7:      x1         7 0.94887102</span></span>
<span><span class="co">#&gt;  8:      x1         8 0.89685041</span></span>
<span><span class="co">#&gt;  9:      x1         9 0.84535227</span></span>
<span><span class="co">#&gt; 10:      x1        10 0.77662104</span></span>
<span><span class="co">#&gt; 11:      x2         1 0.03134738</span></span>
<span><span class="co">#&gt; 12:      x2         2 0.00861283</span></span>
<span><span class="co">#&gt; 13:      x2         3 0.03274140</span></span>
<span><span class="co">#&gt; 14:      x2         4 0.01858428</span></span>
<span><span class="co">#&gt; 15:      x2         5 0.01583010</span></span>
<span><span class="co">#&gt; 16:      x2         6 0.01212995</span></span>
<span><span class="co">#&gt; 17:      x2         7 0.02287022</span></span>
<span><span class="co">#&gt; 18:      x2         8 0.04921564</span></span>
<span><span class="co">#&gt; 19:      x2         9 0.02549185</span></span>
<span><span class="co">#&gt; 20:      x2        10 0.02198419</span></span>
<span><span class="co">#&gt; 21:      x3         1 0.57562797</span></span>
<span><span class="co">#&gt; 22:      x3         2 0.55186044</span></span>
<span><span class="co">#&gt; 23:      x3         3 0.43997816</span></span>
<span><span class="co">#&gt; 24:      x3         4 0.51727252</span></span>
<span><span class="co">#&gt; 25:      x3         5 0.45247422</span></span>
<span><span class="co">#&gt; 26:      x3         6 0.55005612</span></span>
<span><span class="co">#&gt; 27:      x3         7 0.58135317</span></span>
<span><span class="co">#&gt; 28:      x3         8 0.57428653</span></span>
<span><span class="co">#&gt; 29:      x3         9 0.57553603</span></span>
<span><span class="co">#&gt; 30:      x3        10 0.56575902</span></span>
<span><span class="co">#&gt; 31:      x4         1 0.02027085</span></span>
<span><span class="co">#&gt; 32:      x4         2 0.02503951</span></span>
<span><span class="co">#&gt; 33:      x4         3 0.02154713</span></span>
<span><span class="co">#&gt; 34:      x4         4 0.01902680</span></span>
<span><span class="co">#&gt; 35:      x4         5 0.01762906</span></span>
<span><span class="co">#&gt; 36:      x4         6 0.01416039</span></span>
<span><span class="co">#&gt; 37:      x4         7 0.02854561</span></span>
<span><span class="co">#&gt; 38:      x4         8 0.04073741</span></span>
<span><span class="co">#&gt; 39:      x4         9 0.02999120</span></span>
<span><span class="co">#&gt; 40:      x4        10 0.01050114</span></span>
<span><span class="co">#&gt;     feature iter_rsmp      theta</span></span></code></pre></div>
<p>The authors then propose to construct distribution-free confidence
intervals, e.g. using a sign- or Wilcoxon test We can for example use
[wilcoxon.test] to compute confidence intervals around the estimated
pseudo-median:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">loco_wilcox_ci</span> <span class="op">=</span> <span class="va">loco_obsloss</span><span class="op">[</span>,</span>
<span>    <span class="op">{</span></span>
<span>        <span class="va">tt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/wilcox.test.html" class="external-link">wilcox.test</a></span><span class="op">(</span></span>
<span>            <span class="va">obs_importance</span>,</span>
<span>            conf.int <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>            conf.level <span class="op">=</span> <span class="fl">0.95</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="fu">.</span><span class="op">(</span></span>
<span>            <span class="co"># SE = sd(obs_importance) / sqrt(length(obs_importance)),</span></span>
<span>            statistic <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">statistic</span>,</span>
<span>            estimate <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">estimate</span>,</span>
<span>            p.value <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">p.value</span>,</span>
<span>            conf_lower <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,</span>
<span>            conf_upper <span class="op">=</span> <span class="va">tt</span><span class="op">$</span><span class="va">conf.int</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="op">}</span>,</span>
<span>    by <span class="op">=</span> <span class="va">feature</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="va">loco_wilcox_ci</span></span>
<span><span class="co">#&gt;    feature statistic   estimate       p.value conf_lower conf_upper</span></span>
<span><span class="co">#&gt;     &lt;char&gt;     &lt;num&gt;      &lt;num&gt;         &lt;num&gt;      &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:      x1   1946600 0.92071769 1.005087e-293 0.88095522 0.96136374</span></span>
<span><span class="co">#&gt; 2:      x2   1244504 0.02682832  3.497731e-21 0.02125478 0.03242075</span></span>
<span><span class="co">#&gt; 3:      x3   1904433 0.59886721 2.585291e-268 0.57044921 0.62728264</span></span>
<span><span class="co">#&gt; 4:      x4   1362327 0.02991671  1.388275e-44 0.02566247 0.03431650</span></span></code></pre></div>
<p><strong>Note</strong>: The above approach needs checking with the
literature to ensure it’s actually corresponding to what was proposed
and the results are valid.</p>
<p>The main point of this section is to illustrate that the availability
of the intermediate parts (i.e. obs losses) and flexibility regarding
the used measure allows for flexibility in terms of inference.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://lukasburk.de" class="external-link">Lukas Burk</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
