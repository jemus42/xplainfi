<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Feature Samplers • xplainfi</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/Roboto_Slab-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Feature Samplers">
<script defer src="https://umami.jemu.name/script.js" data-website-id="248c8668-4908-4c63-86f7-db0a1b19758a"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">xplainfi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9004</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/xplainfi.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Method Showcase</h6></li>
    <li><a class="dropdown-item" href="../articles/perturbation-importance.html">Perturbation-Based Methods (PFI, CFI, RFI)</a></li>
    <li><a class="dropdown-item" href="../articles/loco.html">Model Refitting Measures (LOCO, WVIM)</a></li>
    <li><a class="dropdown-item" href="../articles/sage-methods.html">Shapley Additive Global Importance (SAGE)</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Specialized Topics</h6></li>
    <li><a class="dropdown-item" href="../articles/feature-samplers.html">Feature Samplers</a></li>
    <li><a class="dropdown-item" href="../articles/inference.html">Inference for Feature Importances</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Testing &amp; Validation</h6></li>
    <li><a class="dropdown-item" href="../articles/simulation-settings.html">Simulation Settings</a></li>
    <li><a class="dropdown-item" href="../articles/fippy-comparison.html">Comparison with fippy (Python)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jemus42/xplainfi/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Feature Samplers</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jemus42/xplainfi/blob/main/vignettes/feature-samplers.Rmd" class="external-link"><code>vignettes/feature-samplers.Rmd</code></a></small>
      <div class="d-none name"><code>feature-samplers.Rmd</code></div>
    </div>

    
    
<p>Feature samplers are a core component of perturbation-based feature
importance methods (PFI, CFI, RFI) and other methods based on some form
of marginilization (SAGE). They determine how features are replaced or
perturbed when evaluating feature importance. This vignette introduces
the different types of feature samplers available in xplainfi and
demonstrates their use.</p>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>We create two tasks: One with mixed features (the seminal penguins
data), and one with all-numeric features.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://jemus42.github.io/xplainfi/">xplainfi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3.mlr-org.com" class="external-link">mlr3</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mlr3learners.mlr-org.com" class="external-link">mlr3learners</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a task for demonstration</span></span>
<span><span class="va">task_mixed</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">tsk</a></span><span class="op">(</span><span class="st">"penguins"</span><span class="op">)</span></span>
<span><span class="va">task_numeric</span> <span class="op">=</span> <span class="fu"><a href="../reference/sim_dgp_scenarios.html">sim_dgp_correlated</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="base-class-featuresampler">Base Class: FeatureSampler<a class="anchor" aria-label="anchor" href="#base-class-featuresampler"></a>
</h2>
<p>All feature samplers inherit from the <code>FeatureSampler</code>
base class, which provides a common interface for sampling features.</p>
<div class="section level3">
<h3 id="key-properties">Key Properties<a class="anchor" aria-label="anchor" href="#key-properties"></a>
</h3>
<p><strong>Feature Type Support</strong>: Each sampler declares which
feature types it supports:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Check supported feature types for different samplers</span></span>
<span><span class="va">task_mixed</span><span class="op">$</span><span class="va">feature_types</span></span>
<span><span class="co">#&gt; Key: &lt;id&gt;</span></span>
<span><span class="co">#&gt;                id    type</span></span>
<span><span class="co">#&gt;            &lt;char&gt;  &lt;char&gt;</span></span>
<span><span class="co">#&gt; 1:     bill_depth numeric</span></span>
<span><span class="co">#&gt; 2:    bill_length numeric</span></span>
<span><span class="co">#&gt; 3:      body_mass integer</span></span>
<span><span class="co">#&gt; 4: flipper_length integer</span></span>
<span><span class="co">#&gt; 5:         island  factor</span></span>
<span><span class="co">#&gt; 6:            sex  factor</span></span>
<span><span class="co">#&gt; 7:           year integer</span></span>
<span><span class="va">permutation</span> <span class="op">=</span> <span class="va"><a href="../reference/MarginalPermutationSampler.html">MarginalPermutationSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_mixed</span><span class="op">)</span></span>
<span><span class="va">permutation</span><span class="op">$</span><span class="va">feature_types</span></span>
<span><span class="co">#&gt; [1] "numeric"   "factor"    "ordered"   "integer"   "logical"   "Date"     </span></span>
<span><span class="co">#&gt; [7] "POSIXct"   "character"</span></span></code></pre></div>
<p><strong>Two Sampling Methods</strong>:</p>
<ol style="list-style-type: decimal">
<li>
<code>$sample(feature, row_ids)</code> - Sample from the stored
task</li>
<li>
<code>$sample_newdata(feature, newdata)</code> - Sample using
external data</li>
</ol>
<p>Let’s demonstrate both with the permutation sampler:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample from stored task (using row_ids)</span></span>
<span><span class="va">sampled_task</span> <span class="op">=</span> <span class="va">permutation</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"bill_length"</span>,</span>
<span>    row_ids <span class="op">=</span> <span class="fl">40</span><span class="op">:</span><span class="fl">45</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sampled_task</span></span>
<span><span class="co">#&gt;    species bill_depth bill_length body_mass flipper_length island    sex  year</span></span>
<span><span class="co">#&gt;     &lt;fctr&gt;      &lt;num&gt;       &lt;num&gt;     &lt;int&gt;          &lt;int&gt; &lt;fctr&gt; &lt;fctr&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:  Adelie       19.1        39.8      4650            184  Dream   male  2007</span></span>
<span><span class="co">#&gt; 2:  Adelie       18.0        44.1      3150            182  Dream female  2007</span></span>
<span><span class="co">#&gt; 3:  Adelie       18.4        37.0      3900            195  Dream   male  2007</span></span>
<span><span class="co">#&gt; 4:  Adelie       18.5        36.5      3100            186  Dream female  2007</span></span>
<span><span class="co">#&gt; 5:  Adelie       19.7        40.8      4400            196  Dream   male  2007</span></span>
<span><span class="co">#&gt; 6:  Adelie       16.9        36.0      3000            185  Dream female  2007</span></span>
<span></span>
<span><span class="co"># Sample from "external" data</span></span>
<span><span class="va">test_data</span> <span class="op">=</span> <span class="va">task_mixed</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">40</span><span class="op">:</span><span class="fl">45</span><span class="op">)</span></span>
<span><span class="va">sampled_external</span> <span class="op">=</span> <span class="va">permutation</span><span class="op">$</span><span class="fu">sample_newdata</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"bill_length"</span>,</span>
<span>    newdata <span class="op">=</span> <span class="va">test_data</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sampled_external</span></span>
<span><span class="co">#&gt;    species bill_depth bill_length body_mass flipper_length island    sex  year</span></span>
<span><span class="co">#&gt;     &lt;fctr&gt;      &lt;num&gt;       &lt;num&gt;     &lt;int&gt;          &lt;int&gt; &lt;fctr&gt; &lt;fctr&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1:  Adelie       19.1        36.5      4650            184  Dream   male  2007</span></span>
<span><span class="co">#&gt; 2:  Adelie       18.0        37.0      3150            182  Dream female  2007</span></span>
<span><span class="co">#&gt; 3:  Adelie       18.4        39.8      3900            195  Dream   male  2007</span></span>
<span><span class="co">#&gt; 4:  Adelie       18.5        44.1      3100            186  Dream female  2007</span></span>
<span><span class="co">#&gt; 5:  Adelie       19.7        36.0      4400            196  Dream   male  2007</span></span>
<span><span class="co">#&gt; 6:  Adelie       16.9        40.8      3000            185  Dream female  2007</span></span></code></pre></div>
<p>Notice that:</p>
<ul>
<li>The sampled feature values change (they are permuted)</li>
<li>Other features and the target remain unchanged</li>
<li>The data structure is preserved</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="permutation-sampler">Permutation Sampler<a class="anchor" aria-label="anchor" href="#permutation-sampler"></a>
</h2>
<p>The <code>MarginalPermutationSampler</code> performs simple random
permutation of features, breaking their relationship with the target and
other features. This is the classic approach used in Permutation Feature
Importance (PFI).</p>
<p><strong>How it works:</strong></p>
<ul>
<li>Each feature is randomly shuffled (permuted) independently</li>
<li>The association between feature values and target values is
broken</li>
<li>The association between feature values <strong>across rows</strong>
is broken</li>
<li>The marginal distribution of each feature is preserved</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create permutation sampler</span></span>
<span><span class="va">permutation</span> <span class="op">=</span> <span class="va"><a href="../reference/MarginalPermutationSampler.html">MarginalPermutationSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_mixed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample a continuous feature</span></span>
<span><span class="va">original</span> <span class="op">=</span> <span class="va">task_mixed</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">sampled</span> <span class="op">=</span> <span class="va">permutation</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="st">"bill_length"</span>, row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare original and sampled values</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    original_bill <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">bill_length</span>,</span>
<span>    sampled_bill <span class="op">=</span> <span class="va">sampled</span><span class="op">$</span><span class="va">bill_length</span>,</span>
<span>    sex <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">sex</span> <span class="co"># Unchanged</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     original_bill sampled_bill    sex</span></span>
<span><span class="co">#&gt;             &lt;num&gt;        &lt;num&gt; &lt;fctr&gt;</span></span>
<span><span class="co">#&gt;  1:          39.1         42.0   male</span></span>
<span><span class="co">#&gt;  2:          39.5         39.1 female</span></span>
<span><span class="co">#&gt;  3:          40.3           NA female</span></span>
<span><span class="co">#&gt;  4:            NA         34.1   &lt;NA&gt;</span></span>
<span><span class="co">#&gt;  5:          36.7         39.5 female</span></span>
<span><span class="co">#&gt;  6:          39.3         36.7   male</span></span>
<span><span class="co">#&gt;  7:          38.9         38.9 female</span></span>
<span><span class="co">#&gt;  8:          39.2         39.2   male</span></span>
<span><span class="co">#&gt;  9:          34.1         40.3   &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 10:          42.0         39.3   &lt;NA&gt;</span></span></code></pre></div>
<p>Note that the permutation is only performed <em>within</em> the
requested <code>row_ids</code>.</p>
<p><strong>Use in PFI</strong>: The permutation sampler is used by
default in Permutation Feature Importance</p>
</div>
<div class="section level2">
<h2 id="marginal-reference-sampler">Marginal Reference Sampler<a class="anchor" aria-label="anchor" href="#marginal-reference-sampler"></a>
</h2>
<p>The <code>MarginalReferenceSampler</code> is another type of marginal
sampler that samples complete rows from reference data. Unlike
<code>MarginalPermutationSampler</code> which shuffles feature values
independently, this sampler preserves within-row dependencies by
sampling intact observations.</p>
<p><strong>Key differences from MarginalPermutationSampler:</strong></p>
<ul>
<li>
<strong>MarginalPermutationSampler</strong>: Shuffles each feature
independently → breaks dependencies between sampled features</li>
<li>
<strong>MarginalReferenceSampler</strong>: Samples complete
reference rows → preserves dependencies of the sampled features</li>
</ul>
<p>This is the approach used in <a href="https://github.com/iancovert/sage" class="external-link">SAGE (Shapley Additive Global
importancE)</a> for marginal feature importance. In this SAGE
implementation, the <a href="https://github.com/iancovert/sage/blob/master/sage/imputers.py#L44-L78" class="external-link"><code>MarginalImputer</code></a>,
uses this approach. The “imputer” name comes from the “imputation” of
model predictions using out-of-coalition features by sampling from their
marginal distribution. In <code>xplainfi</code>, we separate the
“feature sampling” and “model prediction” steps (for now), which is why
we keep the sampling infrastructure independent.</p>
<p><strong>How it works:</strong></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create marginal reference sampler with n_samples reference pool</span></span>
<span><span class="va">marginal_ref</span> <span class="op">=</span> <span class="va"><a href="../reference/MarginalReferenceSampler.html">MarginalReferenceSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_mixed</span>, n_samples <span class="op">=</span> <span class="fl">30L</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample a feature - each row gets values from a randomly sampled reference row</span></span>
<span><span class="va">original</span> <span class="op">=</span> <span class="va">task_mixed</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">sampled</span> <span class="op">=</span> <span class="va">marginal_ref</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="st">"bill_length"</span>, row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    original_bill <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">bill_length</span>,</span>
<span>    sampled_bill <span class="op">=</span> <span class="va">sampled</span><span class="op">$</span><span class="va">bill_length</span>,</span>
<span>    sex <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">sex</span> <span class="co"># Unchanged</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    original_bill sampled_bill    sex</span></span>
<span><span class="co">#&gt;            &lt;num&gt;        &lt;num&gt; &lt;fctr&gt;</span></span>
<span><span class="co">#&gt; 1:          39.1         51.1   male</span></span>
<span><span class="co">#&gt; 2:          39.5         41.1 female</span></span>
<span><span class="co">#&gt; 3:          40.3         38.3 female</span></span>
<span><span class="co">#&gt; 4:            NA         46.4   &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5:          36.7         41.1 female</span></span></code></pre></div>
<p><strong>Parameters:</strong></p>
<ul>
<li>
<code>n_samples</code>: Controls the size of the reference data pool
<ul>
<li>If <code>NULL</code>: uses all task data</li>
<li>If specified: subsamples that many rows from task</li>
</ul>
</li>
</ul>
<p><strong>Preserving within-row correlations:</strong></p>
<p>To demonstrate the difference, consider features that are correlated
as in <code>task_numeric</code>. Here, <code>x1</code> and
<code>x2</code> are correlated, and if we sample them jointly, only
<code>MarginalReferenceSampler</code> retains their original correlation
(approximately).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sample with MarginalPermutationSampler (breaks correlations)</span></span>
<span><span class="va">perm</span> <span class="op">=</span> <span class="va"><a href="../reference/MarginalPermutationSampler.html">MarginalPermutationSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_numeric</span><span class="op">)</span></span>
<span><span class="va">sampled_perm</span> <span class="op">=</span> <span class="va">perm</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span>, row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample with MarginalReferenceSampler (preserves within-row correlations)</span></span>
<span><span class="va">ref</span> <span class="op">=</span> <span class="va"><a href="../reference/MarginalReferenceSampler.html">MarginalReferenceSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_numeric</span>, n_samples <span class="op">=</span> <span class="fl">50L</span><span class="op">)</span></span>
<span><span class="va">sampled_ref</span> <span class="op">=</span> <span class="va">ref</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span>, row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check correlations</span></span>
<span><span class="va">cor_original</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">task_numeric</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">x1</span>, <span class="va">task_numeric</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span><span class="op">)</span><span class="op">$</span><span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">cor_perm</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">sampled_perm</span><span class="op">$</span><span class="va">x1</span>, <span class="va">sampled_perm</span><span class="op">$</span><span class="va">x2</span><span class="op">)</span></span>
<span><span class="va">cor_ref</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="va">sampled_ref</span><span class="op">$</span><span class="va">x1</span>, <span class="va">sampled_ref</span><span class="op">$</span><span class="va">x2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Original"</span>, <span class="st">"Permutation"</span>, <span class="st">"Reference"</span><span class="op">)</span>,</span>
<span>    correlation <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cor_original</span>, <span class="va">cor_perm</span>, <span class="va">cor_ref</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;         method correlation</span></span>
<span><span class="co">#&gt;         &lt;char&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:    Original   0.8794067</span></span>
<span><span class="co">#&gt; 2: Permutation   0.2353592</span></span>
<span><span class="co">#&gt; 3:   Reference   0.8579748</span></span></code></pre></div>
<p>The reference sampler better preserves the correlation structure
because it samples complete rows, while permutation completely breaks
the dependency.</p>
</div>
<div class="section level2">
<h2 id="conditional-samplers">Conditional Samplers<a class="anchor" aria-label="anchor" href="#conditional-samplers"></a>
</h2>
<p>Conditional samplers account for dependencies between features by
sampling from <span class="math inline">\(P(X_j | X_{-j})\)</span>
rather than the marginal <span class="math inline">\(P(X_j)\)</span>.
This is relevant when features are correlated.</p>
<p>All conditional samplers inherit from <code>ConditionalSampler</code>
and support:</p>
<ul>
<li>Specifying which features to condition on via
<code>conditioning_set</code>
</li>
<li>Both <code>$sample()</code> and <code>$sample_newdata()</code>
methods</li>
<li>Mixed feature types (depending on the specific sampler)</li>
</ul>
<div class="section level3">
<h3 id="gaussian-conditional-sampler">Gaussian Conditional Sampler<a class="anchor" aria-label="anchor" href="#gaussian-conditional-sampler"></a>
</h3>
<p>The <code>ConditionalGaussianSampler</code> assumes features follow a
multivariate Gaussian distribution and uses closed-form conditional
distributions.</p>
<p><strong>Advantages</strong>:</p>
<ul>
<li>Very fast (no model fitting during sampling)</li>
<li>Deterministic given a seed</li>
<li>No hyperparameters</li>
</ul>
<p><strong>Limitations</strong>:</p>
<ul>
<li>Assumes multivariate normality</li>
<li>Only supports continuous features</li>
<li>May produce out-of-range values</li>
</ul>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create Gaussian conditional sampler</span></span>
<span><span class="va">gaussian</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalGaussianSampler.html">ConditionalGaussianSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_numeric</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample x1 conditioned on other features</span></span>
<span><span class="va">sampled</span> <span class="op">=</span> <span class="va">gaussian</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"x1"</span>,</span>
<span>    row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x2"</span>, <span class="st">"x3"</span>, <span class="st">"x4"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare original and conditionally sampled values</span></span>
<span><span class="va">original</span> <span class="op">=</span> <span class="va">task_numeric</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    original <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">x1</span>,</span>
<span>    sampled <span class="op">=</span> <span class="va">sampled</span><span class="op">$</span><span class="va">x1</span>,</span>
<span>    x2 <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">x2</span> <span class="co"># Conditioning feature (unchanged)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;        original       sampled         x2</span></span>
<span><span class="co">#&gt;           &lt;num&gt;         &lt;num&gt;      &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1: -1.05068376  0.1621207720 -0.5272128</span></span>
<span><span class="co">#&gt;  2: -2.06809208 -1.0256534013 -1.2991235</span></span>
<span><span class="co">#&gt;  3:  1.13656002  0.3037750530  1.3031674</span></span>
<span><span class="co">#&gt;  4: -1.67500747 -1.3601136679 -1.1771093</span></span>
<span><span class="co">#&gt;  5: -0.35705594 -0.4412497414 -0.3692326</span></span>
<span><span class="co">#&gt;  6: -0.13511336 -0.0008602544  0.2388833</span></span>
<span><span class="co">#&gt;  7:  0.88352949 -0.3288406905 -0.2852529</span></span>
<span><span class="co">#&gt;  8: -0.55523636 -1.6344225147 -1.3064160</span></span>
<span><span class="co">#&gt;  9: -0.47024600 -1.1859281874 -0.3218053</span></span>
<span><span class="co">#&gt; 10: -0.02536502 -0.5130306461 -0.4861314</span></span></code></pre></div>
<p>Notice that the sampled values respect the conditional distribution -
they’re different from the original but plausible given the conditioning
features.</p>
</div>
<div class="section level3">
<h3 id="arf-sampler">ARF Sampler<a class="anchor" aria-label="anchor" href="#arf-sampler"></a>
</h3>
<p>The <code>ConditionalARFSampler</code> uses Adversarial Random
Forests to model complex conditional distributions. It’s the most
flexible conditional sampler.</p>
<p><strong>Advantages</strong>:</p>
<ul>
<li>Handles mixed feature types (continuous, categorical, ordered)</li>
<li>No distributional assumptions</li>
<li>Captures non-linear relationships</li>
</ul>
<p><strong>Limitations</strong>:</p>
<ul>
<li>Requires fitting ARF model (slower initialization and sampling for
large data)</li>
<li>More hyperparameters to tune</li>
<li>Stochastic sampling</li>
</ul>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create ARF sampler (works with full task including categorical features)</span></span>
<span><span class="va">arf</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalARFSampler.html">ConditionalARFSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_mixed</span>, num_trees <span class="op">=</span> <span class="fl">20</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample island conditioned on body measurements</span></span>
<span><span class="va">sampled</span> <span class="op">=</span> <span class="va">arf</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"island"</span>,</span>
<span>    row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bill_length"</span>, <span class="st">"body_mass"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compare original and sampled island</span></span>
<span><span class="va">original</span> <span class="op">=</span> <span class="va">task_mixed</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    original_island <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">island</span>,</span>
<span>    sampled_island <span class="op">=</span> <span class="va">sampled</span><span class="op">$</span><span class="va">island</span>,</span>
<span>    bill_length <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">bill_length</span>, <span class="co"># Conditioning feature</span></span>
<span>    body_mass <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">body_mass</span> <span class="co"># Conditioning feature</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;     original_island sampled_island bill_length body_mass</span></span>
<span><span class="co">#&gt;              &lt;fctr&gt;         &lt;fctr&gt;       &lt;num&gt;     &lt;int&gt;</span></span>
<span><span class="co">#&gt;  1:       Torgersen      Torgersen        39.1      3750</span></span>
<span><span class="co">#&gt;  2:       Torgersen      Torgersen        39.5      3800</span></span>
<span><span class="co">#&gt;  3:       Torgersen         Biscoe        40.3      3250</span></span>
<span><span class="co">#&gt;  4:       Torgersen          Dream          NA        NA</span></span>
<span><span class="co">#&gt;  5:       Torgersen      Torgersen        36.7      3450</span></span>
<span><span class="co">#&gt;  6:       Torgersen         Biscoe        39.3      3650</span></span>
<span><span class="co">#&gt;  7:       Torgersen          Dream        38.9      3625</span></span>
<span><span class="co">#&gt;  8:       Torgersen         Biscoe        39.2      4675</span></span>
<span><span class="co">#&gt;  9:       Torgersen         Biscoe        34.1      3475</span></span>
<span><span class="co">#&gt; 10:       Torgersen          Dream        42.0      4250</span></span></code></pre></div>
<p><strong>Use in CFI</strong>: ConditionalARFSampler is the default for
Conditional Feature Importance since it can be used with any task,
unlike other samplers.</p>
</div>
<div class="section level3">
<h3 id="ctree-conditional-sampler">Ctree Conditional Sampler<a class="anchor" aria-label="anchor" href="#ctree-conditional-sampler"></a>
</h3>
<p>The <code>ConditionalCtreeSampler</code> uses conditional inference
trees to partition the feature space and sample from local
neighborhoods.</p>
<p><strong>Advantages</strong>:</p>
<ul>
<li>Handles mixed feature types</li>
<li>Interpretable tree structure</li>
<li>Automatic feature selection (only splits on informative
features)</li>
</ul>
<p><strong>Limitations</strong>:</p>
<ul>
<li>Requires tree building (slower than kNN)</li>
<li>May produce duplicates if terminal nodes are small</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create ctree sampler</span></span>
<span><span class="va">ctree</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalCtreeSampler.html">ConditionalCtreeSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_mixed</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample with default parameters</span></span>
<span><span class="va">sampled</span> <span class="op">=</span> <span class="va">ctree</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"bill_length"</span>,</span>
<span>    row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="st">"island"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">original</span> <span class="op">=</span> <span class="va">task_mixed</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    island <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">island</span>, <span class="co"># Conditioning feature</span></span>
<span>    original <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">bill_length</span>,</span>
<span>    sampled <span class="op">=</span> <span class="va">sampled</span><span class="op">$</span><span class="va">bill_length</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;        island original sampled</span></span>
<span><span class="co">#&gt;        &lt;fctr&gt;    &lt;num&gt;   &lt;num&gt;</span></span>
<span><span class="co">#&gt;  1: Torgersen     39.1    33.5</span></span>
<span><span class="co">#&gt;  2: Torgersen     39.5    43.1</span></span>
<span><span class="co">#&gt;  3: Torgersen     40.3    35.7</span></span>
<span><span class="co">#&gt;  4: Torgersen       NA    39.7</span></span>
<span><span class="co">#&gt;  5: Torgersen     36.7    37.2</span></span>
<span><span class="co">#&gt;  6: Torgersen     39.3    42.5</span></span>
<span><span class="co">#&gt;  7: Torgersen     38.9    46.0</span></span>
<span><span class="co">#&gt;  8: Torgersen     39.2    39.5</span></span>
<span><span class="co">#&gt;  9: Torgersen     34.1    35.2</span></span>
<span><span class="co">#&gt; 10: Torgersen     42.0    38.5</span></span></code></pre></div>
<p>The ctree sampler partitions observations based on the conditioning
features and samples from within the same partition (terminal node).</p>
</div>
<div class="section level3">
<h3 id="knn-conditional-sampler">kNN Conditional Sampler<a class="anchor" aria-label="anchor" href="#knn-conditional-sampler"></a>
</h3>
<p>The <code>ConditionalKNNSampler</code> finds k nearest neighbors
based on conditioning features and samples from them.</p>
<p><strong>Advantages</strong>:</p>
<ul>
<li>Very simple and intuitive</li>
<li>Fast (no model fitting)</li>
<li>Single hyperparameter (k)</li>
<li>Automatic distance metric selection</li>
<li>Supports mixed feature types (numeric, categorical, ordered,
logical)</li>
</ul>
<p><strong>Limitations</strong>:</p>
<ul>
<li>Sensitive to choice of k</li>
<li>May produce duplicates if k is small</li>
</ul>
<p><strong>Distance metric</strong>:</p>
<p>The sampler automatically selects the appropriate distance metric
based on conditioning features:</p>
<ul>
<li>
<strong>Euclidean distance</strong> when all conditioning features
are numeric/integer (standardized)</li>
<li>
<strong>Gower distance</strong> when any conditioning features are
categorical (factor, ordered, logical)</li>
</ul>
<div class="section level4">
<h4 id="example-1-all-numeric-conditioning-euclidean-distance">Example 1: All-numeric conditioning (Euclidean distance)<a class="anchor" aria-label="anchor" href="#example-1-all-numeric-conditioning-euclidean-distance"></a>
</h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create kNN sampler with k=5 neighbors</span></span>
<span><span class="va">knn_numeric</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalKNNSampler.html">ConditionalKNNSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_numeric</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample x1 based on nearest neighbors in (x2, x3) space</span></span>
<span><span class="va">sampled_numeric</span> <span class="op">=</span> <span class="va">knn_numeric</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"x1"</span>,</span>
<span>    row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x2"</span>, <span class="st">"x3"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">original_numeric</span> <span class="op">=</span> <span class="va">task_numeric</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    x2 <span class="op">=</span> <span class="va">original_numeric</span><span class="op">$</span><span class="va">x2</span>,</span>
<span>    x3 <span class="op">=</span> <span class="va">original_numeric</span><span class="op">$</span><span class="va">x3</span>,</span>
<span>    original_x1 <span class="op">=</span> <span class="va">original_numeric</span><span class="op">$</span><span class="va">x1</span>,</span>
<span>    sampled_x1 <span class="op">=</span> <span class="va">sampled_numeric</span><span class="op">$</span><span class="va">x1</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;            x2         x3 original_x1  sampled_x1</span></span>
<span><span class="co">#&gt;         &lt;num&gt;      &lt;num&gt;       &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: -0.5272128  1.7361110  -1.0506838 -0.04454979</span></span>
<span><span class="co">#&gt; 2: -1.2991235 -0.8452478  -2.0680921 -0.48853558</span></span>
<span><span class="co">#&gt; 3:  1.3031674 -0.9615715   1.1365600  1.13656002</span></span>
<span><span class="co">#&gt; 4: -1.1771093  1.0174911  -1.6750075 -1.76674799</span></span>
<span><span class="co">#&gt; 5: -0.3692326 -1.4960537  -0.3570559 -0.32732251</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="example-2-mixed-type-conditioning-gower-distance">Example 2: Mixed-type conditioning (Gower distance)<a class="anchor" aria-label="anchor" href="#example-2-mixed-type-conditioning-gower-distance"></a>
</h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Use task with categorical features</span></span>
<span><span class="va">knn_mixed</span> <span class="op">=</span> <span class="va"><a href="../reference/ConditionalKNNSampler.html">ConditionalKNNSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_mixed</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Sample bill_length conditioning on island (categorical) and body_mass (numeric)</span></span>
<span><span class="va">sampled_mixed</span> <span class="op">=</span> <span class="va">knn_mixed</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="st">"bill_length"</span>,</span>
<span>    row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>,</span>
<span>    conditioning_set <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"island"</span>, <span class="st">"body_mass"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">original_mixed</span> <span class="op">=</span> <span class="va">task_mixed</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    island <span class="op">=</span> <span class="va">original_mixed</span><span class="op">$</span><span class="va">island</span>,</span>
<span>    body_mass <span class="op">=</span> <span class="va">original_mixed</span><span class="op">$</span><span class="va">body_mass</span>,</span>
<span>    original_bill <span class="op">=</span> <span class="va">original_mixed</span><span class="op">$</span><span class="va">bill_length</span>,</span>
<span>    sampled_bill <span class="op">=</span> <span class="va">sampled_mixed</span><span class="op">$</span><span class="va">bill_length</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;       island body_mass original_bill sampled_bill</span></span>
<span><span class="co">#&gt;       &lt;fctr&gt;     &lt;int&gt;         &lt;num&gt;        &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1: Torgersen      3750          39.1         40.9</span></span>
<span><span class="co">#&gt; 2: Torgersen      3800          39.5         38.6</span></span>
<span><span class="co">#&gt; 3: Torgersen      3250          40.3         41.1</span></span>
<span><span class="co">#&gt; 4: Torgersen        NA            NA         34.6</span></span>
<span><span class="co">#&gt; 5: Torgersen      3450          36.7           NA</span></span></code></pre></div>
<p>The kNN sampler finds the k most similar observations (based on
conditioning features) and samples from their feature values. The
distance metric is chosen automatically based on feature types.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="knockoff-samplers">Knockoff Samplers<a class="anchor" aria-label="anchor" href="#knockoff-samplers"></a>
</h2>
<p>Now that we’ve seen conditional samplers, we can understand an
important limitation of knockoff samplers: unlike the conditional
samplers above, knockoffs <strong>don’t support arbitrary conditioning
sets</strong>.</p>
<p>Knockoff samplers create synthetic features (knockoffs) that satisfy
specific statistical properties. They must fulfill the <strong>knockoff
swap property</strong>: swapping a feature with its knockoff should not
change the joint distribution.</p>
<p>Knockoffs are a separate category because:</p>
<ol style="list-style-type: decimal">
<li>They require special construction to satisfy theoretical guarantees,
and implementations are limited</li>
<li>They don’t support conditional sampling with arbitrary conditioning
sets</li>
<li>They’re used primarily for feature selection with FDR control, not
general importance</li>
</ol>
<div class="section level3">
<h3 id="gaussian-knockoffs">Gaussian Knockoffs<a class="anchor" aria-label="anchor" href="#gaussian-knockoffs"></a>
</h3>
<p>For multivariate Gaussian data, we can construct exact knockoffs:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create Gaussian knockoff sampler (using task_numeric from earlier)</span></span>
<span><span class="va">knockoff</span> <span class="op">=</span> <span class="va"><a href="../reference/KnockoffGaussianSampler.html">KnockoffGaussianSampler</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="va">task_numeric</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Generate knockoffs</span></span>
<span><span class="va">original</span> <span class="op">=</span> <span class="va">task_numeric</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">knockoffs</span> <span class="op">=</span> <span class="va">knockoff</span><span class="op">$</span><span class="fu">sample</span><span class="op">(</span></span>
<span>    feature <span class="op">=</span> <span class="va">task_numeric</span><span class="op">$</span><span class="va">feature_names</span>,</span>
<span>    row_ids <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Original vs knockoff values</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span>
<span>    x1_original <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">x1</span>,</span>
<span>    x1_knockoff <span class="op">=</span> <span class="va">knockoffs</span><span class="op">$</span><span class="va">x1</span>,</span>
<span>    x2_original <span class="op">=</span> <span class="va">original</span><span class="op">$</span><span class="va">x2</span>,</span>
<span>    x2_knockoff <span class="op">=</span> <span class="va">knockoffs</span><span class="op">$</span><span class="va">x2</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;    x1_original x1_knockoff x2_original x2_knockoff</span></span>
<span><span class="co">#&gt;          &lt;num&gt;       &lt;num&gt;       &lt;num&gt;       &lt;num&gt;</span></span>
<span><span class="co">#&gt; 1:  -1.0506838  -0.5923490  -0.5272128  -1.0681303</span></span>
<span><span class="co">#&gt; 2:  -2.0680921  -0.2506029  -1.2991235  -0.9736194</span></span>
<span><span class="co">#&gt; 3:   1.1365600   1.3070985   1.3031674   1.3367546</span></span>
<span><span class="co">#&gt; 4:  -1.6750075  -0.5921971  -1.1771093  -1.2278440</span></span>
<span><span class="co">#&gt; 5:  -0.3570559   0.8674447  -0.3692326   1.0278541</span></span></code></pre></div>
<p>Key properties of knockoffs:</p>
<ul>
<li>Different values but similar statistical properties</li>
<li>Pairwise exchangeability with originals</li>
<li>Preserve correlation structure</li>
<li>Cannot specify which features to condition on (determined by the
knockoff construction)</li>
</ul>
<p><strong>Conditional Independence Testing</strong>: Knockoffs are
particularly relevant for conditional independence testing as
implemented in the <a href="https://cran.r-project.org/package=cpi" class="external-link">cpi
package</a>. You can combine knockoff samplers with CFI and perform
inference:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CFI with knockoff sampler for conditional independence testing</span></span>
<span><span class="va">cfi_knockoff</span> <span class="op">=</span> <span class="va"><a href="../reference/CFI.html">CFI</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span></span>
<span>    task <span class="op">=</span> <span class="va">task_numeric</span>,</span>
<span>    learner <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">lrn</a></span><span class="op">(</span><span class="st">"regr.ranger"</span><span class="op">)</span>,</span>
<span>    measure <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html" class="external-link">msr</a></span><span class="op">(</span><span class="st">"regr.mse"</span><span class="op">)</span>,</span>
<span>    sampler <span class="op">=</span> <span class="va">knockoff</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Compute importance with CPI-based inference</span></span>
<span><span class="va">cfi_knockoff</span><span class="op">$</span><span class="fu">compute</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">cfi_knockoff</span><span class="op">$</span><span class="fu">importance</span><span class="op">(</span>ci_method <span class="op">=</span> <span class="st">"cpi"</span><span class="op">)</span></span></code></pre></div>
<p>See <code>vignette("inference")</code> for more details on
statistical inference with feature importance.</p>
<p><strong>Key takeaways</strong>:</p>
<ul>
<li>
<strong>Permutation sampling</strong> produces any value from the
marginal distribution</li>
<li>
<strong>Conditional samplers</strong> produce values consistent with
conditioning features</li>
<li>Choice of sampler affects feature importance estimates, especially
when features are correlated</li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<table class="table">
<colgroup>
<col width="16%">
<col width="26%">
<col width="24%">
<col width="13%">
<col width="18%">
</colgroup>
<thead><tr class="header">
<th>Sampler</th>
<th>Feature Types</th>
<th>Assumptions</th>
<th>Speed</th>
<th>Use Case</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>MarginalPermutationSampler</code></td>
<td>All</td>
<td>None</td>
<td>Very fast</td>
<td>PFI, uncorrelated features</td>
</tr>
<tr class="even">
<td><code>KnockoffGaussianSampler</code></td>
<td>Continuous</td>
<td>Multivariate normal</td>
<td>Fast</td>
<td>Model-X knockoffs</td>
</tr>
<tr class="odd">
<td><code>ConditionalGaussianSampler</code></td>
<td>Continuous</td>
<td>Multivariate normal</td>
<td>Very fast</td>
<td>CFI with continuous features</td>
</tr>
<tr class="even">
<td><code>ConditionalARFSampler</code></td>
<td>All</td>
<td>None</td>
<td>Moderate</td>
<td>CFI, complex dependencies</td>
</tr>
<tr class="odd">
<td><code>ConditionalCtreeSampler</code></td>
<td>All</td>
<td>None</td>
<td>Moderate</td>
<td>CFI, interpretable sampling</td>
</tr>
<tr class="even">
<td><code>ConditionalKNNSampler</code></td>
<td>All</td>
<td>None (auto-selects distance)</td>
<td>Fast</td>
<td>CFI, simple local structure</td>
</tr>
</tbody>
</table>
<p><strong>General guidelines</strong>:</p>
<ol style="list-style-type: decimal">
<li>Use <strong>permutation sampling</strong> when features are
independent or for baseline PFI</li>
<li>Use <strong>Gaussian conditional</strong> for fast conditional
sampling with continuous features</li>
<li>Use <strong>ARF</strong> for the most flexible conditional sampling
with mixed types</li>
<li>Use <strong>kNN</strong> for simple, fast conditional sampling</li>
<li>Use <strong>ctree</strong> when you want interpretable conditional
sampling</li>
<li>Use <strong>knockoffs</strong> when you need theoretical guarantees
for feature selection and inference</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://lukasburk.de" class="external-link">Lukas Burk</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
