---
title: "xplainvi"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{xplainvi}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(xplainvi)

# learners, tasks, etc.
library(mlr3)
library(mlr3learners)
```

Defining a simple example case:

- German credit classification task
- Random forests with 100 trees
- Holdout split (TBI)
- Measure: Classification error

```{r setup-problem}
task = tsk("german_credit")
learner = lrn("classif.ranger", num.trees = 500)
measure = msr("classif.ce")
```

## Simple case without resampling

Default behavior will internally construct standard holdout resampling with default ratio

Calculating PFI: 

```{r}
pfi = PFI$new(
  task = task, 
  learner = learner,
  measure = measure
)

# Stores parameter set to calculate PFI in different ways
pfi$param_set

set.seed(123)

# Default behavior should be sane
pfi$compute()
```

Q: Should `$compute()` be run on construction? Between the call to `$new()` and `$compute()` there's nothing that needs to happen technically, as long as the `relation` param could be set directly.

Does not recompute if not needed:

```{r}
pfi$compute(relation = "difference")
```

Recomputes if param changes, stores new param

```{r}
pfi$compute(relation = "ratio")
pfi$param_set
```

Q: When `$compute()` is called again its default value for `"relation"` (i.e. `"difference"`) is used, which doesn't seem ideal.
Maybe this default should be the param stored in the object itself rather than feel like a separate function.

```{r}
pfi$compute()
```

Retrieve scores and convert to DT:

```{r}
pfi$importance
as.data.table(pfi)
```

## With resampling

```{r}
learner = lrn("classif.ranger", num.trees = 100)
resampling = rsmp("cv", folds = 3)
measure = msr("classif.ce")

pfi = PFI$new(
  task = task, 
  learner = learner, 
  resampling = resampling,
  measure = measure
)

pfi$resampling
pfi$resample_result

pfi$compute(relation = "difference")

pfi$resample_result

pfi$importance
```

Different measure:  

Q: Maybe it would be worth allowing to change measure post-hoc?

```{r}
learner$predict_type = "prob"

pfi = PFI$new(
  task = task, 
  learner = learner, 
  resampling = resampling,
  measure = msr("classif.auc")
)

pfi$compute(relation = "ratio")
pfi$compute(relation = "difference")
```

Q: Results are importance scores averaged over resampling iterations to ensure the "named numeric" return format.
But what about the individual scores across resampling iterations?  
If we want to attempt uncertainty quantification or at least also report SDs there needs to be a `data.table` return type.
